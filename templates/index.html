{% extends 'base.html' %}

{% block title %}–ú–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞{% endblock %}

{% block extra_css %}
<style>
    .product-img { height: 200px; object-fit: cover; }
    .card { transition: transform 0.2s; }
    .card:hover { transform: scale(1.02); }
    .cart-badge { font-size: 0.8rem; vertical-align: top; }
</style>
{% endblock %}

{% block header_buttons %}
<button class="btn btn-warning position-relative" onclick="openCartModal()">
    üõí –ö–æ—Ä–∑–∏–Ω–∞
    <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
</button>
{% endblock %}

{% block content %}
<div class="container py-5">
    <h2 class="text-center mb-4">–ù–∞—à–µ –ú–µ–Ω—é</h2>
    <div class="row row-cols-1 row-cols-md-3 g-4">
        {% for product in products %}
        <div class="col">
            <div class="card h-100 shadow-sm">
                {% if product.image %}
                    <img src="{{ product.image.url }}" class="card-img-top product-img">
                {% else %}
                    <img src="https://via.placeholder.com/300x200" class="card-img-top product-img">
                {% endif %}
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ product.name }}</h5>
                    <p class="card-text text-muted small">{{ product.description|truncatewords:10 }}</p>
                    <div class="mt-auto d-flex justify-content-between align-items-center">
                        <span class="fs-5 fw-bold">{{ product.price }} ‚ÇΩ</span>
                        <button class="btn btn-outline-success" 
                                onclick="addToCart({{ product.id }}, '{{ product.name }}', {{ product.price }})">
                            + –í –∫–æ—Ä–∑–∏–Ω—É
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–¢–æ –∂–µ —Å–∞–º–æ–µ, —á—Ç–æ –∏ –±—ã–ª–æ) -->
<div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–í–∞—à –∑–∞–∫–∞–∑ üõçÔ∏è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-hover">
                    <thead>
                        <tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö–æ–ª-–≤–æ</th><th>–¶–µ–Ω–∞</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>
                    </thead>
                    <tbody id="cartTableBody"></tbody>
                </table>
                <hr>
                <div class="input-group mb-3 w-50 ms-auto">
                    <span class="input-group-text">üéüÔ∏è</span>
                    <input type="text" class="form-control" id="promoCodeInput" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥">
                </div>

                <h4 class="text-end">–ò—Ç–æ–≥–æ: <span id="cartTotal">0</span> ‚ÇΩ</h4>
                <hr>
                <form id="orderForm">
                    <div class="mb-3"><label>–í–∞—à–µ –∏–º—è</label><input type="text" class="form-control" id="clientName" required></div>
                    <div class="mb-3"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="tel" class="form-control" id="clientPhone" required></div>
                    <div class="mb-3"><label>–ê–¥—Ä–µ—Å</label><textarea class="form-control" id="clientAddress" required></textarea></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-success" onclick="submitOrder()">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    // --- –°—Ç–∞—Ä—ã–π JS –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã ---
    let cart = [];
    let cartModal;

    function addToCart(id, name, price) {
        const existingItem = cart.find(item => item.id === id);
        if (existingItem) {
            existingItem.qty += 1;
        } else {
            cart.push({ id: id, name: name, price: price, qty: 1 });
        }
        updateCartBadge();
    }

    function updateCartBadge() {
        const totalQty = cart.reduce((sum, item) => sum + item.qty, 0);
        document.getElementById('cartCount').innerText = totalQty;
    }

    function openCartModal() {
        const tbody = document.getElementById('cartTableBody');
        tbody.innerHTML = '';
        let total = 0;

        // –†–∏—Å—É–µ–º —Ç–∞–±–ª–∏—Ü—É
        if (cart.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">–ü—É—Å—Ç–æ... üï∏Ô∏è</td></tr>';
        } else {
            cart.forEach((item, index) => {
                const rowSum = item.price * item.qty;
                total += rowSum;
                tbody.innerHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.qty} —à—Ç.</td>
                        <td>${rowSum} ‚ÇΩ</td>
                        <td><button class="btn btn-sm btn-danger" onclick="removeFromCart(${index})">√ó</button></td>
                    </tr>`;
            });
        }

        document.getElementById('cartTotal').innerText = total;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥–∞–ª–∫—É (Bootstrap 5)
        cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
        cartModal.show();
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCartBadge();
        // –•–∞–∫: –∑–∞–∫—Ä—ã–≤–∞–µ–º –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å (–ø—Ä–æ—Å—Ç–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ)
        cartModal.hide();
        setTimeout(() => openCartModal(), 200);
    }

    // --- –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –û–¢–ü–†–ê–í–ö–ê ---
    async function submitOrder() {
        if (cart.length === 0) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!");

        const data = {
            first_name: document.getElementById('clientName').value,
            phone_number: document.getElementById('clientPhone').value,
            address: document.getElementById('clientAddress').value,

            // –ú–∞—Å—Å–∏–≤ —Ç–æ–≤–∞—Ä–æ–≤
            items: cart.map(item => ({ product: item.id, quantity: item.qty })),

            // –ü—Ä–æ–º–æ–∫–æ–¥ (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞)
            promo_code_str: document.getElementById('promoCodeInput') ? document.getElementById('promoCodeInput').value : ""
        };

        try {
            const response = await fetch('/api/orders/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                const result = await response.json();
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å—Ç–∞—Ç—É—Å–∞
                window.location.href = `/order/${result.id}/`;
            } else {
                const err = await response.json();
                alert('–û—à–∏–±–∫–∞ –∑–∞–∫–∞–∑–∞: ' + JSON.stringify(err));
            }
        } catch (error) {
            console.error(error);
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–∫—Ä–∏–ø—Ç–∞');
        }
    }
</script>
{% endblock %}